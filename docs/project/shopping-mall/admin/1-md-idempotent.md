---
layout: default
title: "[admin] MD 상태변경 멱등 처리"
parent: admin
nav_order: 1
---


# MD 상태변경 멱등 처리

* 질문:
	* 결제완료에서 md확인하면 상품준비중이 됨. ok 다시 반복하면 왜 멱등이지? 상품준비중인 상태에서 md확인이라는건 값이 다르잖아? 상태 변경이 없다는 의미로 멱등이라는 건가?

여기서 말하는 “멱등(idempotent)”은 **“같은 액션을 여러 번 호출해도 최종 상태가 변하지 않는다”**는 의미예요.

- `md_confirm`의 계약은 “**결제완료(2)면 → 상품준비중(3)으로 승격**”이에요.
    
- 이미 `상품준비중(3)` 이상이면 이 액션을 다시 호출해도 **추가 상태 변경을 하지 않고 성공(OK)로 처리**합니다. = **멱등**
    

즉, “값이 다르다”의 기준을 **입력 문자열이 아니라 ‘주문의 현재 상태’**로 잡았기 때문에,  
`preparing(3)` 상태에서 또 `md_confirm`을 호출해도 **상태가 더 올라가거나 내려가진 않아요**. 이게 멱등입니다.

### 왜 이렇게 설계?

- 관리자가 실수로 **같은 버튼을 두 번 눌러도 안전**해야 해서 (중복 클릭/재시도 대비)
    
- **네트워크 재전송**이나 **프런트 재호출**에도 시스템 상태가 더 변하지 않도록
    

### 권장 동작(요약)

- 현재 2 → 3으로 **단 한 번만** 전이
    
- 현재가 3/4/5/6이면:
    
    - **상태 변경 없음**,
        
    - **성공 코드(예: rc=0)** 로 반환,
        
    - 로그에 “md_confirm(멱등): 현재상태=preparing/shipping/…” 같은 메시지만 남김
        

### 의사코드

```sql
IF action = 'md_confirm' THEN
  IF status = 2 THEN           -- paid
    UPDATE ... SET status = 3; -- preparing
    LOG 'MD 주문확인 → preparing'
  ELSEIF status IN (3,4,5,6) THEN
    -- no-op, but success
    LOG CONCAT('MD 주문확인(멱등): 현재상태=', status_text);
  ELSE
    SIGNAL '현재 상태에서 MD 주문확인을 할 수 없습니다.';
  END IF;
END IF;

```


정리하면:

- **멱등 = “다시 눌러도 시스템 최종 상태가 동일”**
    
- `preparing`에서 `md_confirm`은 **상태 변경이 없다는 의미의 멱등**이 맞습니다.